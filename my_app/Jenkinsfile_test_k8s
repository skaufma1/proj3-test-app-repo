pipeline {
    agent {label "master"}
    
    environment {
        IMAGE_NAME = 'shmuelk1/proj3-test-flask-app:1.0.1'
    }

    stages {
        
        stage ('Check conn to EKS') {
            
            steps {
                
                sh 'kubectl get all'
                sh 'kubectl apply -f flask-namespace.yaml'

                script {
                    def yamlContent = readFile('flask-deployment.yaml')
                    yamlContent = yamlContent.replaceAll('\\{\\{IMAGE_NAME\\}\\}', env.IMAGE_NAME)
                    writeFile file: 'modified-flask-deployment.yaml', text: yamlContent

                    sh 'kubectl apply -f modified-flask-deployment.yaml'
                }

                sh 'kubectl apply -f flask-service.yaml'
                sh 'kubectl apply -f flask-elb-service.yaml'
            }
        }
    }

}